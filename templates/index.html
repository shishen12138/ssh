<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>AWS SSH 管理面板</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    .btn { margin: 5px; padding: 5px 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 5px; text-align: center; }
    #logs { 
      background: black; 
      color: lime; 
      height: 400px; 
      overflow-y: scroll; 
      padding: 10px; 
      font-size: 12px; 
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>AWS SSH 管理面板</h2>

  <!-- 手动添加主机 -->
  <h3>手动添加主机</h3>
  <input type="text" id="manual_ip" placeholder="IP">
  <input type="text" id="manual_name" placeholder="备注">
  <input type="text" id="manual_user" placeholder="用户名 (默认 root)">
  <input type="text" id="manual_pass" placeholder="密码 (默认 Qcy1994@06)">
  <button class="btn" onclick="addManualHost()">添加</button>

  <!-- AWS 批量导入 -->
  <h3>AWS 批量导入</h3>
  <textarea id="aws_accounts" rows="5" cols="80" placeholder="账号格式：任意----Access Key----Secret Key"></textarea><br>
  <button class="btn" onclick="importAwsHosts()">导入</button>

  <!-- 主机列表 -->
  <h3>主机列表</h3>
  <table id="hosts_table">
    <thead>
      <tr>
        <th><input type="checkbox" id="select_all" onclick="toggleSelectAll()"></th>
        <th>IP</th>
        <th>备注</th>
        <th>状态</th>
        <th>CPU</th>
        <th>内存</th>
        <th>流量</th>
        <th>延迟</th>
        <th>进程Top5</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 批量执行命令 -->
  <h3>执行命令</h3>
  <input type="text" id="command" placeholder="输入要执行的命令">
  <button class="btn" onclick="execCommand()">执行</button>

  <!-- 日志 -->
  <h3>实时日志</h3>
  <div id="logs"></div>

  <script>
    function loadHosts() {
      axios.get("/hosts").then(res => {
        let tbody = document.querySelector("#hosts_table tbody");
        tbody.innerHTML = "";
        res.data.forEach(h => {
          let row = `<tr>
            <td><input type="checkbox" class="host_check" value="${h.ip}"></td>
            <td>${h.ip}</td>
            <td>${h.name}</td>
            <td>${h.status || ""}</td>
            <td>${h.cpu || ""}</td>
            <td>${h.memory || ""}</td>
            <td>${h.traffic || ""}</td>
            <td>${h.latency || ""}</td>
            <td><pre>${h.top5 || ""}</pre></td>
            <td>
              <button class="btn" onclick="recoverHost('${h.ip}')">恢复</button>
              <button class="btn" onclick="editHost('${h.ip}')">修改凭证</button>
            </td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });
    }

    function addManualHost() {
      let ip = document.getElementById("manual_ip").value;
      let name = document.getElementById("manual_name").value;
      let username = document.getElementById("manual_user").value || "root";
      let password = document.getElementById("manual_pass").value || "Qcy1994@06";
      axios.post("/add_manual_host", {ip, name, username, password})
        .then(() => loadHosts());
    }

    function importAwsHosts() {
      let lines = document.getElementById("aws_accounts").value.trim().split("\n");
      let accounts = lines.map(line => {
        let parts = line.split("----");
        return { label: parts[0], access_key: parts[1], secret_key: parts[2] };
      });
      axios.post("/import_aws_hosts", {accounts})
        .then(() => loadHosts());
    }

    function execCommand() {
      let command = document.getElementById("command").value;
      let selected = Array.from(document.querySelectorAll(".host_check:checked")).map(cb => cb.value);
      axios.post("/exec", {ips: selected, command: command});
    }

    function toggleSelectAll() {
      let checked = document.getElementById("select_all").checked;
      document.querySelectorAll(".host_check").forEach(cb => cb.checked = checked);
    }

    function recoverHost(ip) {
      axios.post("/recover_host", {ip: ip}).then(() => loadHosts());
    }

    function editHost(ip) {
      let username = prompt("请输入新的用户名", "root");
      let password = prompt("请输入新的密码", "Qcy1994@06");
      if (!username || !password) {
        alert("用户名和密码不能为空！");
        return;
      }
      axios.post("/update_host", {ip, username, password})
        .then(() => loadHosts());
    }

    function loadLogs() {
      axios.get("/logs").then(res => {
        let logs = document.getElementById("logs");
        logs.innerText = res.data.join("\n");
        logs.scrollTop = logs.scrollHeight;
      });
    }

    setInterval(loadHosts, 5000);
    setInterval(loadLogs, 2000);
    loadHosts();
    loadLogs();
  </script>
</body>
</html>
