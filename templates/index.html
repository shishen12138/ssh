<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SSH 管理面板</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f2f2f2; }
    #logs { background: black; color: lime; height: 200px; overflow-y: scroll; padding: 10px; }
    .btn { padding: 6px 12px; margin: 2px; cursor: pointer; border: 1px solid #444; border-radius: 5px; }
    .btn:hover { background: #ddd; }
  </style>
</head>
<body>
  <h2>SSH 管理面板</h2>

  <!-- 批量命令执行 -->
  <div>
    <input type="text" id="command" placeholder="输入命令">
    <button class="btn" onclick="execCommand()">执行命令</button>
  </div>

  <!-- 手动添加主机 -->
  <h3>手动添加主机</h3>
  <input type="text" id="manual_ip" placeholder="IP">
  <input type="text" id="manual_name" placeholder="备注">
  <button class="btn" onclick="addManualHost()">添加</button>

  <!-- AWS 导入 -->
  <h3>AWS 批量导入</h3>
  <textarea id="aws_accounts" rows="3" cols="50" placeholder="格式: 任意----AccessKey----SecretKey (一行一个)"></textarea><br>
  <button class="btn" onclick="importAwsHosts()">导入</button>

  <!-- 主机表格 -->
  <h3>主机列表</h3>
  <table id="hostTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
        <th>IP</th>
        <th>备注</th>
        <th>CPU%</th>
        <th>内存%</th>
        <th>网络</th>
        <th>延迟</th>
        <th>进程Top5</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="hostBody"></tbody>
  </table>

  <!-- 日志 -->
  <h3>日志</h3>
  <div id="logs"></div>

  <script>
    let selectedIps = [];

    // 执行命令
    function execCommand() {
      let command = document.getElementById("command").value;
      let ips = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
      console.log("[DEBUG][前端] execCommand 发送", {ips, command});
      axios.post("/exec_command", {ips, command})
        .then(res => console.log("[DEBUG][前端] 执行命令返回:", res.data))
        .catch(err => console.error("[ERROR][前端] 执行命令失败:", err));
    }

    // 手动添加主机
    function addManualHost() {
      let ip = document.getElementById("manual_ip").value;
      let name = document.getElementById("manual_name").value;
      console.log("[DEBUG][前端] addManualHost 发送", {ip, name});
      axios.post("/add_manual_host", {ip, name})
        .then(res => {
          console.log("[DEBUG][前端] 手动添加返回:", res.data);
          loadHosts();
        })
        .catch(err => console.error("[ERROR][前端] 手动添加失败:", err));
    }

    // AWS 导入
    function importAwsHosts() {
      let lines = document.getElementById("aws_accounts").value.trim().split("\n");
      let accounts = lines.map(line => {
        let parts = line.split("----");
        return {label: parts[0], access_key: parts[1], secret_key: parts[2]};
      });
      console.log("[DEBUG][前端] importAwsHosts 发送", {accounts});
      axios.post("/import_aws_hosts", {accounts})
        .then(res => {
          console.log("[DEBUG][前端] AWS 导入返回:", res.data);
          loadHosts();
        })
        .catch(err => console.error("[ERROR][前端] AWS 导入失败:", err));
    }

    // 恢复主机
    function recoverHost(ip) {
      console.log("[DEBUG][前端] recoverHost 发送", {ip});
      axios.post("/recover_host", {ip})
        .then(res => {
          console.log("[DEBUG][前端] 恢复返回:", res.data);
          loadHosts();
        })
        .catch(err => console.error("[ERROR][前端] 恢复失败:", err));
    }

    // 载入主机表格
    function loadHosts() {
      axios.get("/monitor_data").then(res => {
        let data = res.data;
        let body = document.getElementById("hostBody");
        body.innerHTML = "";
        for (let ip in data) {
          let row = `<tr>
            <td><input type="checkbox" class="chk" value="${ip}"></td>
            <td>${ip}</td>
            <td>-</td>
            <td>${data[ip].cpu}</td>
            <td>${data[ip].memory}</td>
            <td>${data[ip].network}</td>
            <td>${data[ip].ping}</td>
            <td><pre>${data[ip].top5_processes}</pre></td>
            <td><button class="btn" onclick="recoverHost('${ip}')">恢复</button></td>
          </tr>`;
          body.innerHTML += row;
        }
      });
    }

    // 日志刷新
    function loadLogs() {
      axios.get("/logs").then(res => {
        let logs = res.data.logs.join("");
        let logDiv = document.getElementById("logs");
        logDiv.innerText = logs;
        logDiv.scrollTop = logDiv.scrollHeight;
      });
    }

    // 全选/全不选
    function toggleAll(source) {
      document.querySelectorAll(".chk").forEach(c => c.checked = source.checked);
    }

    // 定时刷新
    setInterval(loadHosts, 5000);
    setInterval(loadLogs, 3000);

    loadHosts();
    loadLogs();
  </script>
</body>
</html>
