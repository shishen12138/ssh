<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SSH 管理面板</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* 页面自适应 */
    body { font-family: Arial; margin: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }

    /* 表格样式 */
    table { border-collapse: collapse; width: 100%; margin-top: 20px; table-layout: fixed; word-wrap: break-word; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 13px; }
    th { background: #f2f2f2; }

    /* 日志框 */
    #logs { 
      background: black; 
      color: lime; 
      height: 300px; 
      overflow-y: scroll; 
      padding: 10px; 
      font-size: 12px; 
      line-height: 1.2em;
    }

    /* 按钮 */
    .btn { padding: 5px 10px; margin: 2px; cursor: pointer; border: 1px solid #444; border-radius: 5px; font-size: 12px; }
    .btn:hover { background: #ddd; }

    /* 输入框 */
    input, textarea { padding: 4px; margin: 2px; font-size: 12px; }
    #aws_accounts { width: 100%; height: 90px; font-size: 10px; }

    /* 表格内容自适应 */
    pre { margin: 0; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>SSH 管理面板</h2>

  <!-- 批量命令执行 -->
  <div style="margin-bottom:10px;">
    <input type="text" id="command" placeholder="输入命令" style="width:60%;">
    <button class="btn" onclick="execCommand()">执行命令</button>
  </div>

  <!-- 手动添加主机 -->
  <h3>手动添加主机</h3>
  <input type="text" id="manual_ip" placeholder="IP">
  <input type="text" id="manual_name" placeholder="备注">
  <button class="btn" onclick="addManualHost()">添加</button>

  <!-- AWS 导入 -->
  <h3>AWS 批量导入</h3>
  <textarea id="aws_accounts" placeholder="格式: 任意----AccessKey----SecretKey (一行一个)"></textarea><br>
  <button class="btn" onclick="importAwsHosts()">导入</button>

  <!-- 主机表格 -->
  <h3>主机列表</h3>
  <table id="hostTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
        <th>IP</th>
        <th>备注</th>
        <th>CPU%</th>
        <th>内存%</th>
        <th>网络</th>
        <th>延迟</th>
        <th>进程Top5</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="hostBody"></tbody>
  </table>

  <!-- 日志 -->
  <h3>日志</h3>
  <div id="logs"></div>

  <script>
    function execCommand() {
      let command = document.getElementById("command").value;
      let ips = Array.from(document.querySelectorAll(".chk:checked")).map(c => c.value);
      axios.post("/exec_command", {ips, command})
        .then(res => console.log("执行命令返回:", res.data))
        .catch(err => console.error("执行命令失败:", err));
    }

    function addManualHost() {
      let ip = document.getElementById("manual_ip").value;
      let name = document.getElementById("manual_name").value;
      axios.post("/add_manual_host", {ip, name})
        .then(res => { loadHosts(); })
        .catch(err => console.error("手动添加失败:", err));
    }

    function importAwsHosts() {
      let lines = document.getElementById("aws_accounts").value.trim().split("\n");
      let accounts = lines.map(line => {
        let parts = line.split("----");
        return {label: parts[0], access_key: parts[1], secret_key: parts[2]};
      });
      axios.post("/import_aws_hosts", {accounts})
        .then(res => { loadHosts(); })
        .catch(err => console.error("AWS 导入失败:", err));
    }

    function recoverHost(ip) {
      axios.post("/recover_host", {ip})
        .then(res => { loadHosts(); })
        .catch(err => console.error("恢复失败:", err));
    }

    function loadHosts() {
      axios.get("/monitor_data").then(res => {
        let data = res.data;
        let body = document.getElementById("hostBody");
        body.innerHTML = "";
        let fragment = document.createDocumentFragment();

        for (let ip in data) {
          let tr = document.createElement('tr');
          let host = data[ip];
          tr.innerHTML = `
            <td><input type="checkbox" class="chk" value="${ip}"></td>
            <td>${ip}</td>
            <td>${host.name || '-'}</td>
            <td>${host.cpu}</td>
            <td>${host.memory}</td>
            <td>${host.network}</td>
            <td>${host.ping}</td>
            <td><pre>${host.top5_processes}</pre></td>
            <td>${host.source === 'aws' ? `<button class="btn" onclick="recoverHost('${ip}')">恢复</button>` : ''}</td>
          `;
          fragment.appendChild(tr);
        }

        body.appendChild(fragment);
      });
    }

    function loadLogs() {
      axios.get("/logs").then(res => {
        let logDiv = document.getElementById("logs");
        logDiv.innerText = res.data.logs.join("");
        logDiv.scrollTop = logDiv.scrollHeight;
      });
    }

    function toggleAll(source) {
      document.querySelectorAll(".chk").forEach(c => c.checked = source.checked);
    }

    setInterval(loadHosts, 5000);
    setInterval(loadLogs, 3000);

    loadHosts();
    loadLogs();
  </script>
</body>
</html>
