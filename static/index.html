<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>AWS SSH 管理面板</title>
<style>
body { background:#1e1e1e; color:#fff; font-family: monospace; }
table { width:100%; border-collapse: collapse; margin-top:10px;}
th, td { border:1px solid #555; padding:5px; text-align:center;}
.progress { height:15px; background:#555; border-radius:5px; overflow:hidden;}
.progress-bar { height:100%; width:0%; text-align:center; color:#000;}
.green { background:lime; }
.yellow { background:yellow; }
.red { background:red; }
#log { height:200px; overflow:auto; background:#111; padding:5px; margin-top:10px;}
button { margin:5px;}
</style>
</head>
<body>

<h2>AWS SSH 管理面板</h2>

<label>AWS Key:</label>
<input type="text" id="aws_key_id" size="50">
<button onclick="importAWS()">导入实例</button>
<button onclick="execCommand()">批量执行 SSH 命令</button>

<table id="host_table">
<thead>
<tr>
<th><input type="checkbox" onclick="selectAll(this)"></th>
<th>IP</th>
<th>CPU</th>
<th>内存</th>
<th>运行天数</th>
<th>操作</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div id="log"></div>

<script>
let ws = new WebSocket("ws://" + location.host + "/ws");

window.hostStatus = {}; // 全局记录状态

ws.onopen = () => { ws.send(JSON.stringify({action:"get_hosts"})); ws.send(JSON.stringify({action:"get_logs"})); };
ws.onmessage = function(evt){
    let data = JSON.parse(evt.data);
    if(data.action=="update_host"){
        let host = data.host;
        window.hostStatus[host.ip] = host.status;
        let row = document.getElementById("row_"+host.ip);
        if(!row){
            let tbody = document.querySelector("#host_table tbody");
            row = tbody.insertRow();
            row.id = "row_"+host.ip;
            row.insertCell(0).innerHTML = `<input type="checkbox" name="host" value="${host.ip}">`;
            row.insertCell(1).innerText = host.ip;
            row.insertCell(2).innerHTML = `<div class="progress"><div id="cpu_${host.ip}" class="progress-bar green" style="width:${host.cpu}%">${host.cpu}%</div></div>`;
            row.insertCell(3).innerHTML = `<div class="progress"><div id="mem_${host.ip}" class="progress-bar green" style="width:${host.memory}%">${host.memory}%</div></div>`;
            row.insertCell(4).innerText = host.runtime_days;
            row.insertCell(5).innerHTML = `<button onclick="changePassword('${host.ip}')">修改密码</button>`;
        }else{
            document.getElementById("cpu_"+host.ip).style.width = host.cpu+"%";
            document.getElementById("cpu_"+host.ip).className = "progress-bar "+getColor(host.cpu);
            document.getElementById("cpu_"+host.ip).innerText = host.cpu+"%";

            document.getElementById("mem_"+host.ip).style.width = host.memory+"%";
            document.getElementById("mem_"+host.ip").className = "progress-bar "+getColor(host.memory);
            document.getElementById("mem_"+host.ip).innerText = host.memory+"%";

            row.cells[4].innerText = host.runtime_days;
        }
    }
    else if(data.log){
        appendLog(data.log);
    }
};

function getColor(val){
    if(val>80) return "red";
    if(val>50) return "yellow";
    return "green";
}

function appendLog(msg){
    let logDiv = document.getElementById("log");
    let span = document.createElement("span");
    span.textContent = msg;
    logDiv.appendChild(span);
    logDiv.appendChild(document.createElement("br"));
    logDiv.scrollTop = logDiv.scrollHeight;
}

function importAWS(){
    let key = document.getElementById("aws_key_id").value;
    if(!key){ alert("请输入 AWS Key"); return; }
    ws.send(JSON.stringify({action:"import_aws", aws_key_id:key}));
    appendLog("正在导入 AWS 实例，请稍候...");
}

function selectAll(cb){
    let checked = cb.checked;
    document.querySelectorAll('input[name="host"]').forEach(ch=>ch.checked=checked);
}

function changePassword(ip){
    let newPwd = prompt("输入新密码", "Qcy1994@06");
    if(newPwd){
        ws.send(JSON.stringify({action:"update_password", ip:ip, password:newPwd}));
        appendLog(`${ip} 密码修改中...`);
    }
}

// ----------------- 批量 SSH 执行 -----------------
function execCommand(){
    let command = prompt("输入要执行的命令","");
    if(!command) return;

    let selectedHosts = [];
    document.querySelectorAll('input[name="host"]:checked').forEach(cb=>selectedHosts.push(cb.value));
    if(selectedHosts.length==0){ alert("请选择主机"); return; }

    appendLog(`开始批量执行命令: ${command}`);
    executeNext(0, selectedHosts, command);
}

function executeNext(index, hosts, command){
    if(index>=hosts.length){
        appendLog("批量命令执行完成");
        return;
    }
    let ip = hosts[index];
    appendLog(`正在执行 ${ip} ...`);
    ws.send(JSON.stringify({action:"exec", ips:[ip], command:command}));

    let checkInterval = setInterval(()=>{
        if(window.hostStatus[ip]=="done"){
            clearInterval(checkInterval);
            executeNext(index+1, hosts, command);
        }
    },1000);
}
</script>
</body>
</html>
