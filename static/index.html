<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>AWS SSH 管理面板</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.progress-bar { height: 16px; border-radius: 4px; }
#log { background-color: black; color: lime; font-family: monospace; }
</style>
</head>
<body class="p-4">

<h1 class="text-2xl font-bold mb-4">AWS SSH 批量管理面板</h1>

<!-- AWS Key 导入 -->
<div class="mb-4">
  <input id="aws_key_id" type="text" placeholder="AccessKey----SecretKey 或 任意前缀----AccessKey----SecretKey" class="border p-1 mr-2 w-1/3">
  <button onclick="importAWS()" class="bg-green-500 text-white px-2 py-1 rounded">导入实例</button>
</div>

<!-- 命令输入 -->
<div class="mb-4">
  <input id="command" type="text" placeholder="输入命令" class="border p-1 w-1/2 mr-2">
  <button onclick="executeCommand()" class="bg-blue-500 text-white px-2 py-1 rounded">执行命令</button>
</div>

<!-- 主机列表 -->
<table class="table-auto border-collapse border border-gray-400 w-full mb-4">
<thead>
<tr class="bg-gray-200">
<th><input type="checkbox" id="select_all" onchange="selectAll(this)"/></th>
<th>IP</th><th>CPU</th><th>内存</th><th>运行天数</th><th>状态</th><th>操作</th>
</tr>
</thead>
<tbody id="host_table"></tbody>
</table>

<!-- 日志 -->
<h2 class="font-bold">日志</h2>
<div id="log" class="border h-48 overflow-auto p-2 mb-4"></div>

<script>
let ws = new WebSocket("ws://localhost:12138/ws");

ws.onopen = ()=>{ ws.send(JSON.stringify({action:"get_hosts"})); };
ws.onmessage = (event)=>{
    let data = JSON.parse(event.data);
    if(data.log){
        let logDiv = document.getElementById("log");
        logDiv.innerHTML += data.log + "<br>";
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    if(data.action=="update_host"){
        updateHostRow(data.host);
    }
};

function updateHostRow(host){
    let tbody = document.getElementById("host_table");
    let row = document.getElementById("row_"+host.ip);
    let cpuColor = host.cpu>80?"bg-red-500":host.cpu>50?"bg-yellow-500":"bg-green-500";
    let memColor = host.memory>80?"bg-red-500":host.memory>50?"bg-yellow-500":"bg-green-500";
    if(!row){
        row = document.createElement("tr");
        row.id = "row_"+host.ip;
        row.innerHTML = `
        <td><input type="checkbox" name="host" value="${host.ip}"></td>
        <td>${host.ip}</td>
        <td><div class="w-24 border"><div class="progress-bar ${cpuColor}" style="width:${host.cpu}%"></div></div>${host.cpu}%</td>
        <td><div class="w-24 border"><div class="progress-bar ${memColor}" style="width:${host.memory}%"></div></div>${host.memory}%</td>
        <td>${host.runtime_days}</td>
        <td>${host.status}</td>
        <td><button onclick="changePassword('${host.ip}')" class="bg-yellow-500 text-white px-1 rounded">修改密码</button></td>
        `;
        tbody.appendChild(row);
    }else{
        row.cells[2].innerHTML = `<div class="w-24 border"><div class="progress-bar ${cpuColor}" style="width:${host.cpu}%"></div></div>${host.cpu}%`;
        row.cells[3].innerHTML = `<div class="w-24 border"><div class="progress-bar ${memColor}" style="width:${host.memory}%"></div></div>${host.memory}%`;
        row.cells[4].innerText = host.runtime_days;
        row.cells[5].innerText = host.status;
    }
}

function executeCommand(){
    let ips = Array.from(document.querySelectorAll('input[name="host"]:checked')).map(cb=>cb.value);
    let cmd = document.getElementById("command").value;
    ws.send(JSON.stringify({action:"exec", ips: ips, command: cmd}));
}

function selectAll(cb){
    let checked = cb.checked;
    document.querySelectorAll('input[name="host"]').forEach(ch=>ch.checked=checked);
}

function changePassword(ip){
    let newPwd = prompt("输入新密码", "Qcy1994@06");
    if(newPwd){
        ws.send(JSON.stringify({action:"update_password", ip:ip, password:newPwd}));
    }
}

function importAWS(){
    let key = document.getElementById("aws_key_id").value;
    if(!key){
        alert("请输入 AWS Key");
        return;
    }
    ws.send(JSON.stringify({action:"import_aws", aws_key_id:key}));
    alert("正在导入实例，请稍候...");
}
</script>

</body>
</html>